<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../Source/Runtime/Utils/Mesh2Shape.js</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/AmbientLight.html">AmbientLight</a></li>
                                <li><a href="../classes/ArraybufferUtils.html">ArraybufferUtils</a></li>
                                <li><a href="../classes/Audio.html">Audio</a></li>
                                <li><a href="../classes/AudioEmitter.html">AudioEmitter</a></li>
                                <li><a href="../classes/Base64Utils.html">Base64Utils</a></li>
                                <li><a href="../classes/BlockScript.html">BlockScript</a></li>
                                <li><a href="../classes/BufferUtils.html">BufferUtils</a></li>
                                <li><a href="../classes/CanvasTexture.html">CanvasTexture</a></li>
                                <li><a href="../classes/Container.html">Container</a></li>
                                <li><a href="../classes/DirectionalLight.html">DirectionalLight</a></li>
                                <li><a href="../classes/FileSystem.html">FileSystem</a></li>
                                <li><a href="../classes/Folder.html">Folder</a></li>
                                <li><a href="../classes/Font.html">Font</a></li>
                                <li><a href="../classes/GORLOT.html">GORLOT</a></li>
                                <li><a href="../classes/GORLOT.Image.html">GORLOT.Image</a></li>
                                <li><a href="../classes/HemisphereLight.html">HemisphereLight</a></li>
                                <li><a href="../classes/Key.html">Key</a></li>
                                <li><a href="../classes/Keyboard.html">Keyboard</a></li>
                                <li><a href="../classes/KinectDevice.html">KinectDevice</a></li>
                                <li><a href="../classes/LeapMotion.html">LeapMotion</a></li>
                                <li><a href="../classes/Material.html">Material</a></li>
                                <li><a href="../classes/Mesh.html">Mesh</a></li>
                                <li><a href="../classes/Mesh2shape.html">Mesh2shape</a></li>
                                <li><a href="../classes/Mouse.html">Mouse</a></li>
                                <li><a href="../classes/MultiMaterial.html">MultiMaterial</a></li>
                                <li><a href="../classes/ObjectUtils.html">ObjectUtils</a></li>
                                <li><a href="../classes/OrthographicCamera.html">OrthographicCamera</a></li>
                                <li><a href="../classes/ParticleEmitter.html">ParticleEmitter</a></li>
                                <li><a href="../classes/PerspectiveCamera.html">PerspectiveCamera</a></li>
                                <li><a href="../classes/PhysicsObject.html">PhysicsObject</a></li>
                                <li><a href="../classes/PointLight.html">PointLight</a></li>
                                <li><a href="../classes/PositionalAudio.html">PositionalAudio</a></li>
                                <li><a href="../classes/RectAreaLight.html">RectAreaLight</a></li>
                                <li><a href="../classes/Resource.html">Resource</a></li>
                                <li><a href="../classes/ResourceManager.html">ResourceManager</a></li>
                                <li><a href="../classes/Scene.html">Scene</a></li>
                                <li><a href="../classes/Script.html">Script</a></li>
                                <li><a href="../classes/SkinnedMesh.html">SkinnedMesh</a></li>
                                <li><a href="../classes/Sky.html">Sky</a></li>
                                <li><a href="../classes/SpineAnimation.html">SpineAnimation</a></li>
                                <li><a href="../classes/SpineTexture.html">SpineTexture</a></li>
                                <li><a href="../classes/SpotLight.html">SpotLight</a></li>
                                <li><a href="../classes/Sprite.html">Sprite</a></li>
                                <li><a href="../classes/Text3D.html">Text3D</a></li>
                                <li><a href="../classes/Texture.html">Texture</a></li>
                                <li><a href="../classes/THREE.Fog.html">THREE.Fog</a></li>
                                <li><a href="../classes/THREE.Object3D.html">THREE.Object3D</a></li>
                                <li><a href="../classes/Video.html">Video</a></li>
                                <li><a href="../classes/VideoTexture.html">VideoTexture</a></li>
                                <li><a href="../classes/WebcamTexture.html">WebcamTexture</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/Animations.html">Animations</a></li>
                                <li><a href="../modules/Audio.html">Audio</a></li>
                                <li><a href="../modules/BinaryData.html">BinaryData</a></li>
                                <li><a href="../modules/Cameras.html">Cameras</a></li>
                                <li><a href="../modules/Core.html">Core</a></li>
                                <li><a href="../modules/Devices.html">Devices</a></li>
                                <li><a href="../modules/Input.html">Input</a></li>
                                <li><a href="../modules/Lights.html">Lights</a></li>
                                <li><a href="../modules/Meshes.html">Meshes</a></li>
                                <li><a href="../modules/Misc.html">Misc</a></li>
                                <li><a href="../modules/Particles.html">Particles</a></li>
                                <li><a href="../modules/Physics.html">Physics</a></li>
                                <li><a href="../modules/Resources.html">Resources</a></li>
                                <li><a href="../modules/Runtime.html">Runtime</a></li>
                                <li><a href="../modules/Script.html">Script</a></li>
                                <li><a href="../modules/Sprite.html">Sprite</a></li>
                                <li><a href="../modules/Textures.html">Textures</a></li>
                                <li><a href="../modules/THREE.html">THREE</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../Source/Runtime/Utils/Mesh2Shape.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&quot;use strict&quot;;

/**
 * Mesh2shape is used to convert ThreeJS objects to CannonJS shapes
 * It is based on the original Mesh2Shape converted by @donmccurdy
 * 
 * @author Don McCurdy (https://github.com/donmccurdy)
 * @class Mesh2shape
 * @static
 * @module Physics
 */
function Mesh2shape(){}

var PI2 = Math.PI / 2

/**
 * Type is used to indentify the type of cannonjs
 *  - BOX
 *  - CYLINDER
 *  - SPHERE
 *  - HULL
 * 
 * @attribute Type
 * @type {Object}
 */
Mesh2shape.Type =
{
	BOX: &quot;Box&quot;,
	CYLINDER: &quot;Cylinder&quot;,
	SPHERE: &quot;Sphere&quot;,
	HULL: &quot;ConvexPolyhedron&quot;
};

/**
 * Given a Object3D instance, creates a corresponding CANNON shape
 *
 * @method createShape
 * @param {Object3D} object
 * @param {String} type Mesh2shape.Type
 * @return {CANNON.Shape} shape
 */
Mesh2shape.createShape = function(object, type)
{
	if(type !== undefined)
	{
		if(type === Mesh2shape.Type.BOX)
		{
			return Mesh2shape.createBoundingBoxShape(object);
		}
		else if(type === Mesh2shape.Type.CYLINDER)
		{
			return Mesh2shape.createBoundingCylinderShape(object, options);
		}
		else if(type === Mesh2shape.Type.SPHERE)
		{
			return Mesh2shape.createBoundingSphereShape(object, options);
		}
		else if(type === Mesh2shape.Type.HULL)
		{
			return Mesh2shape.createConvexPolyhedron(object);
		}
		else
		{
			console.warn(&quot;[CANNON.mesh2shape] Invalid type&quot;, type);
		}
	}

	var geometry = Mesh2shape.getGeometry(object);
	if(!geometry)
	{
		return null;
	}

	type = geometry.metadata ? geometry.metadata.type : geometry.type;
	switch(type)
	{
		case &quot;BoxGeometry&quot;:
		case &quot;BoxBufferGeometry&quot;:
			return Mesh2shape.createBoxShape(geometry);

		case &quot;CylinderGeometry&quot;:
		case &quot;CylinderBufferGeometry&quot;:
			return Mesh2shape.createCylinderShape(geometry);

		case &quot;PlaneGeometry&quot;:
		case &quot;PlaneBufferGeometry&quot;:
			return Mesh2shape.createPlaneShape(geometry);

		case &quot;SphereGeometry&quot;:
		case &quot;SphereBufferGeometry&quot;:
			return Mesh2shape.createSphereShape(geometry);

		case &quot;TubeGeometry&quot;:
			return Mesh2shape.createTubeShape(geometry);

		case &quot;Geometry&quot;:
		case &quot;BufferGeometry&quot;:
			return Mesh2shape.createConvexPolyhedron(object);

		default:
			console.warn(&quot;Unrecognized geometry: Using bounding box as shape.&quot;, geometry.type);
			return Mesh2shape.createBoxShape(geometry);
	}
};

/**
 * Create box shape from geometry
 *
 * @method createBoxShape
 * @param {Geometry} geometry
 * @return {CANNON.Box} shape
 */
Mesh2shape.createBoxShape = function(geometry)
{
	var vertices = Mesh2shape.getVertices(geometry);

	if(!vertices.length)
	{
		return null;
	}

	geometry.computeBoundingBox();
	
	var box = geometry.boundingBox;
	
	return new CANNON.Box(new CANNON.Vec3((box.max.x - box.min.x) / 2,(box.max.y - box.min.y) / 2,(box.max.z - box.min.z) / 2));
}

/**
 * Bounding box needs to be computed with the entire mesh, not just geometry
 *
 * @method createBoundingBoxShape
 * @param {Geometry} geometry
 * @return {CANNON.Box} shape
 */
Mesh2shape.createBoundingBoxShape = function(object)
{
	var localPosition, worldPosition;
	
	var helper = new THREE.BoundingBoxHelper(object);
	helper.update();
	
	var box = helper.box;

	if(!isFinite(box.min.lengthSq()))
	{
		return null;
	}

	var shape = new CANNON.Box(new CANNON.Vec3((box.max.x - box.min.x) / 2, (box.max.y - box.min.y) / 2, (box.max.z - box.min.z) / 2));

	object.updateMatrixWorld();
	worldPosition = new THREE.Vector3();
	worldPosition.setFromMatrixPosition(object.matrixWorld);
	localPosition = helper.position.sub(worldPosition);
	if(localPosition.lengthSq())
	{
		shape.offset = localPosition;
	}

	return shape;
}

/**
 * Computes 3D convex hull as a CANNON.ConvexPolyhedron
 *
 * @method createConvexPolyhedron
 * @param {ConvexPolyhedron} geometry
 * @return {CANNON.Shape} shape
 */
Mesh2shape.createConvexPolyhedron = function(object)
{
	var i, vertices, faces, hull;
	var geometry = Mesh2shape.getGeometry(object);

	if(geometry instanceof THREE.BufferGeometry)
	{
		geometry = new THREE.Geometry().fromBufferGeometry(geometry);
	}

	if(!geometry || !geometry.vertices.length)
	{
		return null;
	}

	//Perturb
	for(i = 0; i &lt; geometry.vertices.length; i++)
	{
		geometry.vertices[i].x +=(Math.random() - 0.5) * 1e-4;
		geometry.vertices[i].y +=(Math.random() - 0.5) * 1e-4;
		geometry.vertices[i].z +=(Math.random() - 0.5) * 1e-4;
	}

	//Compute the 3D convex hull
	var hull = new quickhull()(geometry);
	console.log(hull);

	//Convert from THREE.Vector3 to CANNON.Vec3
	vertices = new Array(hull.vertices.length);
	for(i = 0; i &lt; hull.vertices.length; i++)
	{
		vertices[i] = new CANNON.Vec3(hull.vertices[i].x, hull.vertices[i].y, hull.vertices[i].z);
	}

	//Convert from THREE.Face to Array&lt;number&gt;
	faces = new Array(hull.faces.length);
	for(i = 0; i &lt; hull.faces.length; i++)
	{
		faces[i] = [hull.faces[i].a, hull.faces[i].b, hull.faces[i].c];
	}

	return new CANNON.ConvexPolyhedron(vertices, faces);
}

/**
 * Create cylinder shape from geometry
 *
 * @method createCylinderShape
 * @param {Geometry} geometry
 * @return {CANNON.Cylinder} shape
 */
Mesh2shape.createCylinderShape = function(geometry)
{
	var params = geometry.metadata ? geometry.metadata.parameters : geometry.parameters;

	var shape = new CANNON.Cylinder(params.radiusTop, params.radiusBottom, params.height, params.radialSegments);
	shape.orientation = new CANNON.Quaternion();
	shape.orientation.setFromEuler(THREE.Math.degToRad(-90), 0, 0, &quot;XYZ&quot;).normalize();

	return shape;
}

//Create cylinder shape from bounding cylinder
Mesh2shape.createBoundingCylinderShape = function(object, options)
{
	var axes = [&quot;x&quot;, &quot;y&quot;, &quot;z&quot;],
		majorAxis = options.cylinderAxis || &quot;y&quot;,
		minorAxes = axes.splice(axes.indexOf(majorAxis), 1) &amp;&amp; axes;

	//Compute cylinder dimensions
	var geometry = Mesh2shape.getGeometry(object);
	geometry.computeBoundingBox();
	geometry.computeBoundingSphere();
	var height = geometry.boundingBox.max[majorAxis] - geometry.boundingBox.min[majorAxis];
	var radius = 0.5 * Math.max(geometry.boundingBox.max[minorAxes[0]] - geometry.boundingBox.min[minorAxes[0]],geometry.boundingBox.max[minorAxes[1]] - geometry.boundingBox.min[minorAxes[1]]);

	//Create shape
	var shape = new CANNON.Cylinder(radius, radius, height, 12);
	shape.orientation = new CANNON.Quaternion();
	shape.orientation.setFromEuler(majorAxis === &quot;y&quot; ? PI2 : 0, majorAxis === &quot;z&quot; ? PI2 : 0, 0, &quot;XYZ&quot;).normalize();
	
	return shape;
}

/**
 * Plane shape from geometry
 *
 * @method createPlaneShape
 * @param {Geometry} geometry
 * @return {CANNON.Box} shape
 */
Mesh2shape.createPlaneShape = function(geometry)
{
	geometry.computeBoundingBox();

	var box = geometry.boundingBox;
	return new CANNON.Box(new CANNON.Vec3((box.max.x - box.min.x) / 2 || 0.1, (box.max.y - box.min.y) / 2 || 0.1, (box.max.z - box.min.z) / 2 || 0.1));
}

/**
 * Sphere shape from geometry
 *
 * @method createSphereShape
 * @param {Geometry} geometry
 * @return {CANNON.Sphere} shape
 */
Mesh2shape.createSphereShape = function(geometry)
{
	var params = geometry.metadata ? geometry.metadata.parameters : geometry.parameters;
	return new CANNON.Sphere(params.radius);
}

/**
 * Sphere shape from bouding sphere
 *
 * @method createBoundingSphereShape
 * @param {Geometry} geometry
 * @return {CANNON.Sphere} shape
 */
Mesh2shape.createBoundingSphereShape = function(object, options)
{
	var geometry = Mesh2shape.getGeometry(object);
	geometry.computeBoundingSphere();
	return new CANNON.Sphere(options.sphereRadius || geometry.boundingSphere.radius);
}

/**
 * Sphere shape from bouding sphere
 *
 * @method createTubeShape
 * @param {Geometry} geometry
 * @return {CANNON.Trimesh} shape
 */
Mesh2shape.createTubeShape = function(geometry)
{
	var tmp = new THREE.BufferGeometry();
	tmp.fromGeometry(geometry);
	return createTrimeshShape(tmp);
}

/**
 * Trimesh shape from geometry
 * 
 * @method createTrimeshShape
 * @param {Geometry} geometry
 * @return {CANNON.Trimesh} shape
 */
Mesh2shape.createTrimeshShape = function(geometry)
{
	var indices, vertices = Mesh2shape.getVertices(geometry);

	if(!vertices.length)
	{
		return null;
	}

	indices = Object.keys(vertices).map(Number);
	return new CANNON.Trimesh(vertices, indices);
}

/**
 * Returns a single geometry for the given object
 * If the object is compound, its geometries are automatically merged
 * 
 * @method getGeometry
 * @param {Object3D} object
 * @return {Geometry} Geometry that contains all merger geometry
 */
Mesh2shape.getGeometry = function(object)
{
	var meshes = Mesh2shape.getMeshes(object);

	if(meshes.length === 0)
	{
		return null;
	}

	var tmp = new THREE.Geometry();
	
	//Apply scale (it can&#x27;t easily be applied to a Shape later)
	if(meshes.length === 1)
	{
		var position = new THREE.Vector3();
		var quaternion = new THREE.Quaternion();
		var scale = new THREE.Vector3();

		tmp = meshes[0].geometry.clone();
		tmp.metadata = meshes[0].geometry.metadata;
		meshes[0].updateMatrixWorld();
		meshes[0].matrixWorld.decompose(position, quaternion, scale);

		return tmp.scale(scale.x, scale.y, scale.z);
	}

	var combined = new THREE.Geometry();
	var mesh;

	//Recursively merge geometry, preserving local transforms
	while((mesh = meshes.pop()))
	{
		mesh.updateMatrixWorld();

		if(mesh.geometry instanceof THREE.BufferGeometry)
		{
			tmp.fromBufferGeometry(mesh.geometry);
			combined.merge(tmp, mesh.matrixWorld);
		}
		else
		{
			combined.merge(mesh.geometry, mesh.matrixWorld);
		}
	}

	var matrix = new THREE.Matrix4();
	matrix.scale(object.scale);
	combined.applyMatrix(matrix);
	return combined;
}

/**
 * Get geometry vertices
 *
 * @method getVertices
 * @param {Geometry} geometry
 * @return {Array} array
 */
Mesh2shape.getVertices = function(geometry)
{
	if(!geometry.attributes)
	{
		geometry = new THREE.BufferGeometry().fromGeometry(geometry);
	}
	return geometry.attributes.position.array;
}

/**
 * Returns a array of THREE.Mesh instances from the given object.
 * If nested transformations are found, they are applied to child meshes as mesh.userData.matrix, so that each mesh has its position/rotation/scale independently of all of its parents except the top-level object.
 *
 * @method getMeshes
 * @param {Object3D} object
 * @return {Array} meshes found inside the Object3D
 */
Mesh2shape.getMeshes = function(object)
{
	var meshes = [];

	object.traverse(function(child)
	{
		if(child.type instanceof THREE.Mesh)
		{
			meshes.push(child);
		}
	});

	return meshes;
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
